import json
import requests
import asyncio
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from datetime import datetime

TOKEN = "8517558395:AAHXsx4s2Or80aTU3leDegQM-Wv4oZbPbDE"
KANAL_ID = "161651555"

# GitHub new.json fayli manzili
GITHUB_RAW_URL = "https://raw.githubusercontent.com/username/repo/main/new.json"

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ğŸ‘‹ Ulug'nor Kutubxona Boti\n\n"
        "ğŸ“‹ Komandalar:\n"
        "/start - Botni ishga tushirish\n"
        "/github - GitHub'dan yangiliklarni yuklash\n"
        "/last - Oxirgi yangilikni ko'rish\n"
        "/post - Yangilik yuborish\n\n"
        "ğŸ“š GitHub'dan new.json faylini o'qib, yangiliklarni avtomatik joylaydi"
    )

async def github_yangiliklar(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        await update.message.reply_text("â³ GitHub'dan yangiliklarni yuklayapman...")
        
        # GitHub'dan new.json faylini o'qish
        response = requests.get(GITHUB_RAW_URL, timeout=10)
        
        if response.status_code != 200:
            await update.message.reply_text(f"âŒ GitHub faylini o'qib bo'lmadi: {response.status_code}")
            return
        
        yangiliklar = response.json()
        
        if not isinstance(yangiliklar, list):
            await update.message.reply_text("âŒ new.json formati noto'g'ri. List bo'lishi kerak.")
            return
        
        count = 0
        for yangilik in yangiliklar[:5]:  # Bir vaqtda 5 tasini
            try:
                # Yangilikni tekshirish
                title = yangilik.get('title', 'Yangilik')
                content = yangilik.get('content', '')
                image_url = yangilik.get('image', '')
                date = yangilik.get('date', datetime.now().strftime('%Y-%m-%d'))
                
                # Telegram kanalga yuborish
                post_text = f"ğŸ“¢ {title}\n\n{content}\n\nğŸ“… {date}"
                
                if image_url and image_url.startswith('http'):
                    # Rasm bilan post
                    image_response = requests.get(image_url, timeout=10)
                    if image_response.status_code == 200:
                        # Rasmni fayl sifatida yuborish
                        await context.bot.send_photo(
                            chat_id=KANAL_ID,
                            photo=image_response.content,
                            caption=post_text
                        )
                    else:
                        # Rasm yo'q bo'lsa, faqat matn
                        await context.bot.send_message(
                            chat_id=KANAL_ID,
                            text=post_text
                        )
                else:
                    # Faqat matn
                    await context.bot.send_message(
                        chat_id=KANAL_ID,
                        text=post_text
                    )
                
                count += 1
                await asyncio.sleep(1)  # 1 soniya kutish
                
            except Exception as e:
                await update.message.reply_text(f"âŒ Yangilik yuborishda xato: {str(e)}")
                continue
        
        await update.message.reply_text(f"âœ… {count} ta yangilik kanalga joylandi!")
        
        # Yangiliklarni JSON faylga saqlash
        with open('last_github_news.json', 'w', encoding='utf-8') as f:
            json.dump(yangiliklar[:5], f, ensure_ascii=False, indent=2)
        
    except Exception as e:
        await update.message.reply_text(f"âŒ Xatolik: {str(e)}")

async def oxirgi_yangilik(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Oxirgi saqlangan yangiliklarni ko'rsatish"""
    try:
        with open('last_github_news.json', 'r', encoding='utf-8') as f:
            yangiliklar = json.load(f)
        
        if not yangiliklar:
            await update.message.reply_text("ğŸ“­ Hali yangiliklar yo'q")
            return
        
        javob = "ğŸ“° Oxirgi yangiliklar:\n\n"
        for i, yangilik in enumerate(yangiliklar[:3], 1):
            title = yangilik.get('title', 'Noma\'lum')
            date = yangilik.get('date', '')
            javob += f"{i}. {title}\n   ğŸ“… {date}\n\n"
        
        await update.message.reply_text(javob)
        
    except FileNotFoundError:
        await update.message.reply_text("ğŸ“­ Hali yangiliklar yuklanmagan. /github buyrug'ini ishlating.")
    except Exception as e:
        await update.message.reply_text(f"âŒ Xatolik: {str(e)}")

async def yangilik_yuborish(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Oddiy yangilik yuborish"""
    await update.message.reply_text(
        "ğŸ“ Yangilik yuborish uchun:\n"
        "1. Matn yozing\n"
        "2. Rasm qo'shing (ixtiyoriy)\n"
        "3. Yuboring\n\n"
        "âœ… Yangilik avtomatik kanalga joylanadi!"
    )

async def post_qabul(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Yangilik qabul qilish va kanalga joylash"""
    try:
        matn = update.message.caption or update.message.text
        
        if not matn:
            await update.message.reply_text("âŒ Iltimos, yangilik matnini yozing!")
            return
        
        # Kanalga yuborish
        if update.message.photo:
            rasm = update.message.photo[-1]
            await context.bot.send_photo(
                chat_id=KANAL_ID,
                photo=rasm.file_id,
                caption=matn
            )
        else:
            await context.bot.send_message(
                chat_id=KANAL_ID,
                text=matn
            )
        
        await update.message.reply_text("âœ… Yangilik kanalga joylandi!")
        
    except Exception as e:
        await update.message.reply_text(f"âŒ Xato: {str(e)}")

async def github_test(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """GitHub faylini test qilish"""
    try:
        await update.message.reply_text("ğŸ” GitHub faylini tekshiryapman...")
        
        response = requests.get(GITHUB_RAW_URL, timeout=10)
        
        if response.status_code == 200:
            data = response.json()
            await update.message.reply_text(
                f"âœ… GitHub fayli topildi!\n"
                f"ğŸ“Š Yangiliklar soni: {len(data) if isinstance(data, list) else 'Noma\'lum'}\n"
                f"ğŸ“ Birinchi yangilik: {data[0].get('title', 'Noma\'lum')[:50]}..."
            )
        else:
            await update.message.reply_text(f"âŒ GitHub fayli topilmadi: {response.status_code}")
            
    except Exception as e:
        await update.message.reply_text(f"âŒ Xatolik: {str(e)}")

async def main():
    app = Application.builder().token(TOKEN).build()
    
    # Command handlerlar
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("github", github_yangiliklar))
    app.add_handler(CommandHandler("last", oxirgi_yangilik))
    app.add_handler(CommandHandler("post", yangilik_yuborish))
    app.add_handler(CommandHandler("test", github_test))
    
    # Message handlerlar
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, post_qabul))
    app.add_handler(MessageHandler(filters.PHOTO, post_qabul))
    
    print("ğŸ¤– GitHub Yangilik Boti ishga tushdi!")
    print(f"ğŸ“ GitHub fayli: {GITHUB_RAW_URL}")
    
    await app.run_polling()

if __name__ == "__main__":
    # GitHub URL'ini o'zgartiring
    GITHUB_RAW_URL = "https://raw.githubusercontent.com/username/repo/main/new.json"
    
    asyncio.run(main())
